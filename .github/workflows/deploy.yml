name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main, staging]

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: trade-store

jobs:
  build-and-push:
    name: Build & Push to ECR
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} 2>/dev/null || \
          aws ecr create-repository --repository-name ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: meta
        run: echo "image_tag=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        run: |
          docker build -t ${{ steps.meta.outputs.image_tag }} .
          docker push ${{ steps.meta.outputs.image_tag }}
          # Tag and push as latest so ECS (task def uses trade-store:latest) pulls this image
          docker tag ${{ steps.meta.outputs.image_tag }} ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event.workflow_run.head_branch == 'staging'
    environment: staging

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy API service to staging ECS
        run: |
          aws ecs update-service \
            --cluster trade-store-staging \
            --service trade-store-api \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy Consumer service to staging ECS
        run: |
          aws ecs update-service \
            --cluster trade-store-staging \
            --service trade-store-consumer \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for staging stability
        run: |
          aws ecs wait services-stable \
            --cluster trade-store-staging \
            --services trade-store-api trade-store-consumer \
            --region ${{ env.AWS_REGION }}

      - name: Smoke test staging
        run: |
          STATUS=$(curl -sf -o /dev/null -w "%{http_code}" \
            https://staging.tradestore.example.com/api/v1/health)
          if [ "$STATUS" != "200" ]; then
            echo "Smoke test failed: HTTP $STATUS"
            exit 1
          fi
          echo "Smoke test passed: HTTP $STATUS"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event.workflow_run.head_branch == 'main'
    environment: production  # Requires manual approval via GitHub Environment protection rules

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy API service to production ECS (rolling, min 50%)
        run: |
          aws ecs update-service \
            --cluster trade-store-prod \
            --service trade-store-api \
            --force-new-deployment \
            --deployment-configuration "minimumHealthyPercent=50,maximumPercent=200" \
            --region ${{ env.AWS_REGION }}

      - name: Deploy Consumer service to production ECS
        run: |
          aws ecs update-service \
            --cluster trade-store-prod \
            --service trade-store-consumer \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for production stability
        run: |
          aws ecs wait services-stable \
            --cluster trade-store-prod \
            --services trade-store-api trade-store-consumer \
            --region ${{ env.AWS_REGION }}

      - name: Smoke test production
        run: |
          STATUS=$(curl -sf -o /dev/null -w "%{http_code}" \
            https://tradestore.example.com/api/v1/health)
          if [ "$STATUS" != "200" ]; then
            echo "Production smoke test failed: HTTP $STATUS"
            exit 1
          fi
          echo "Production smoke test passed: HTTP $STATUS"
